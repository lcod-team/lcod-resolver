compose:
  - call: internal/load-descriptor
    in:
      projectPath: $.projectPath
    out:
      descriptor: descriptor
      descriptorText: descriptorText
      descriptorPath: descriptorPath

  - call: internal/load-config
    in:
      projectPath: $.projectPath
      configPath: $.configPath
    out:
      resolverConfig: config
      config: config
      configPath: resolvedConfigPath
      warnings: configWarnings

  - call: internal/lock-path
    in:
      projectPath: $.projectPath
      outputPath: $.outputPath
    out:
      lockPath: lockPath

  - call: internal/prepare-config
    in:
      resolverConfig: $.resolverConfig
      config: $.config
      warnings: $.configWarnings
    out:
      normalizedConfig: normalizedConfig
      warnings: normalizedWarnings

  - call: internal/prepare-cache
    in:
      projectPath: $.projectPath
    out:
      cacheRoot: cacheRoot

  - call: internal/resolve-dependencies
    in:
      projectPath: $.projectPath
      cacheRoot: $.cacheRoot
      normalizedConfig: $.normalizedConfig
      config: $.config
      rootId: $.descriptor.id
      rootDescriptor: $.descriptor
      rootDescriptorText: $.descriptorText
      warnings: $.normalizedWarnings
    out:
      resolverResult: resolverResult
      warnings: resolveWarnings
      contractSourcesSnapshot: contractSourcesSnapshot

  - call: internal/summarize-result
    in:
      resolverResult: $.resolverResult
      warnings: $.resolveWarnings
    out:
      dependencyGraph: dependencyGraph
      rootIntegrity: rootIntegrity
      warnings: collectedWarnings

  - call: internal/build-lock
    in:
      descriptor: $.descriptor
      dependencyGraph: $.dependencyGraph
      warnings: $.collectedWarnings
      rootIntegrity: $.rootIntegrity
      resolverRoot: $.resolverResult.root
    out:
      lockDocument: lockDocument
      lockText: lockText

  - call: lcod://axiom/fs/write-file@1
    in:
      path: $.lockPath
      data: $.lockText
      createParents: true
    out:
      ok: wrote

  - call: lcod://tooling/value/is_array@0.1.0
    in:
      value: $.lockDocument.components
    out:
      hasComponentsArray: ok

  - call: lcod://flow/if@1
    in:
      cond: $.hasComponentsArray
    out:
      normalizedComponents: normalizedComponents
    slots:
      then:
        - call: lcod://impl/set@1
          in:
            normalizedComponents: $.lockDocument.components
          out:
            normalizedComponents: normalizedComponents
      else:
        - call: lcod://impl/set@1
          in:
            normalizedComponents: []
          out:
            normalizedComponents: normalizedComponents

  - call: lcod://tooling/value/default_array@0.1.0
    in:
      value: $.warnings
      fallback: []
    out:
      normalizedWarnings: resolved

  - call: lcod://impl/set@1
    in:
      lockPath: $.lockPath
      components: $.normalizedComponents
      warnings: $.normalizedWarnings
      contractSourcesSnapshot: $.contractSourcesSnapshot
    out:
      lockPath: lockPath
      components: components
      warnings: warnings
      contractSourcesSnapshot: contractSourcesSnapshot
