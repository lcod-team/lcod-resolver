compose:
  - call: lcod://tooling/value/default_object@0.1.0
    in:
      value: $.descriptor
    out:
      descriptorObject: resolved

  - call: lcod://tooling/value/default_object@0.1.0
    in:
      value: $.resolverRoot
    out:
      resolverRootObject: resolved

  - call: lcod://tooling/value/default_array@0.1.0
    in:
      value: $.dependencyGraph
    out:
      dependencyGraphList: resolved

  - call: lcod://contract/core/array/length@1
    in:
      items: $.dependencyGraphList
    out:
      dependencyGraphCount: length
  - call: lcod://tooling/value/default_array@0.1.0
    in:
      value: $.resolverRootObject.dependencies
    out:
      resolverRootDependencies: resolved

  - call: lcod://tooling/value/default_array@0.1.0
    in:
      value: $.warnings
    out:
      normalizedWarnings: resolved

  - call: lcod://impl/set@1
    in:
      componentId: null
      componentSource:
        type: "path"
        path: "."
      normalizedDependencies: []
      fallbackDependencies: []
      componentDependencies: []
    out:
      componentId: componentId
      componentSource: componentSource
      normalizedDependencies: normalizedDependencies
      fallbackDependencies: fallbackDependencies
      componentDependencies: componentDependencies

  - call: lcod://tooling/value/is_string_nonempty@0.1.0
    in:
      value: $.descriptorObject.id
    out:
      descriptorHasId: ok

  - call: lcod://tooling/value/is_string_nonempty@0.1.0
    in:
      value: $.resolverRootObject.id
    out:
      resolverHasId: ok

  - call: lcod://flow/if@1
    in:
      cond: $.descriptorHasId
    out:
      componentId: componentId
    slots:
      then:
        - call: lcod://impl/set@1
          in:
            componentId: $.descriptorObject.id
          out:
            componentId: componentId
      else:
        - call: lcod://flow/if@1
          in:
            cond: $.resolverHasId
          out:
            componentId: componentId
          slots:
            then:
              - call: lcod://impl/set@1
                in:
                  componentId: $.resolverRootObject.id
                out:
                  componentId: componentId
            else:
              - call: lcod://impl/set@1
                in:
                  componentId: null
                out:
                  componentId: componentId

  - call: lcod://tooling/value/is_object@0.1.0
    in:
      value: $.resolverRootObject.source
    out:
      rootHasSource: ok

  - call: lcod://flow/if@1
    in:
      cond: $.rootHasSource
    out:
      componentSource: componentSource
    slots:
      then:
        - call: lcod://impl/set@1
          in:
            componentSource: $.resolverRootObject.source
          out:
            componentSource: componentSource

  - call: lcod://flow/foreach@1
    in:
      list: $.dependencyGraphList
    slots:
      body:
        - call: lcod://tooling/resolver/internal/normalize-dependency@0.1.0
          in:
            node: $slot.item
          out:
            dependencyEntry: entry
            dependencyValid: valid
        - call: lcod://flow/if@1
          in:
            cond: $.dependencyValid
          slots:
            then:
              - call: lcod://tooling/array/append@0.1.0
                in:
                  items: $.normalizedDependencies
                  values:
                    - $.dependencyEntry
                  clone: false
                out:
                  normalizedDependencies: items

  - call: lcod://flow/foreach@1
    in:
      list: $.resolverRootDependencies
    slots:
      body:
        - call: lcod://tooling/resolver/internal/normalize-dependency@0.1.0
          in:
            node: $slot.item
          out:
            fallbackEntry: entry
            fallbackValid: valid
        - call: lcod://flow/if@1
          in:
            cond: $.fallbackValid
          slots:
            then:
              - call: lcod://tooling/array/append@0.1.0
                in:
                  items: $.fallbackDependencies
                  values:
                    - $.fallbackEntry
                  clone: false
                out:
                  fallbackDependencies: items

  - call: lcod://contract/core/array/length@1
    in:
      items: $.normalizedDependencies
    out:
      normalizedDependencyCount: length
  - call: lcod://flow/if@1
    in:
      cond: $.normalizedDependencyCount
    out:
      componentDependencies: componentDependencies
    slots:
      then:
        - call: lcod://impl/set@1
          in:
            componentDependencies: $.normalizedDependencies
          out:
            componentDependencies: componentDependencies
      else:
        - call: lcod://contract/core/array/length@1
          in:
            items: $.fallbackDependencies
          out:
            fallbackCount: length
        - call: lcod://flow/if@1
          in:
            cond: $.fallbackCount
          out:
            componentDependencies: componentDependencies
          slots:
            then:
              - call: lcod://impl/set@1
                in:
                  componentDependencies: $.fallbackDependencies
                out:
                  componentDependencies: componentDependencies
            else:
              - call: lcod://impl/set@1
                in:
                  componentDependencies: $.dependencyGraphList
                out:
                  componentDependencies: componentDependencies

  - call: lcod://tooling/value/is_string_nonempty@0.1.0
    in:
      value: $.rootIntegrity
    out:
      hasIntegrity: ok

  - call: lcod://flow/if@1
    in:
      cond: $.hasIntegrity
    out:
      component: component
    slots:
      then:
        - call: lcod://impl/set@1
          in:
            component:
              id: $.componentId
              resolved: $.componentId
              source: $.componentSource
              dependencies: $.componentDependencies
              integrity: $.rootIntegrity
          out:
            component: component
      else:
        - call: lcod://impl/set@1
          in:
            component:
              id: $.componentId
              resolved: $.componentId
              source: $.componentSource
              dependencies: $.componentDependencies
          out:
            component: component

  - call: lcod://impl/set@1
    in:
      lockDocument:
        schemaVersion: "1.0"
        resolverVersion: "0.1.0"
        components:
          - $.component
    out:
      lockDocument: lockDocument

  - call: lcod://axiom/toml/stringify@1
    in:
      value: $.lockDocument
    out:
      lockText: text

  - call: lcod://impl/set@1
    in:
      lockDocument: $.lockDocument
      lockText: $.lockText
      warnings: $.normalizedWarnings
    out:
      lockDocument: lockDocument
      lockText: lockText
      warnings: warnings
