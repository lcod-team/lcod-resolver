compose:
  - call: internal/load-descriptor
    in:
      projectPath: $.projectPath
    out:
      descriptor: descriptor
      descriptorText: descriptorText
      descriptorPath: descriptorPath

  - call: internal/load-config
    in:
      projectPath: $.projectPath
      configPath: $.configPath
    out:
      config: resolverConfig
      configPath: resolvedConfigPath
      warnings: configWarnings

  - call: internal/lock-path
    in:
      projectPath: $.projectPath
      outputPath: $.outputPath
    out:
      lockPath: lockPath

  - call: internal/prepare-config
    in:
      resolverConfig: $.resolverConfig
      config: $.config
      warnings: $.configWarnings
    out:
      normalizedConfig: normalizedConfig
      warnings: normalizedWarnings

  - call: internal/prepare-cache
    in:
      projectPath: $.projectPath
    out:
      cacheRoot: cacheRoot

  - call: internal/resolve-dependencies
    in:
      projectPath: $.projectPath
      cacheRoot: $.cacheRoot
      normalizedConfig: $.normalizedConfig
      config: $.config
      rootId: $.descriptor.id
      rootDescriptor: $.descriptor
      rootDescriptorText: $.descriptorText
      warnings: $.normalizedWarnings
    out:
      resolverResult: resolverResult
      warnings: resolveWarnings

  - call: internal/summarize-result
    in:
      resolverResult: $.resolverResult
      warnings: $.resolveWarnings
    out:
      dependencyGraph: dependencyGraph
      rootIntegrity: rootIntegrity
      warnings: collectedWarnings

  - call: internal/build-lock
    in:
      descriptor: $.descriptor
      dependencyGraph: $.dependencyGraph
      warnings: $.collectedWarnings
      rootIntegrity: $.rootIntegrity
    out:
      lockDocument: lockDocument
      lockText: lockText

  - call: lcod://axiom/fs/write-file@1
    in:
      path: $.lockPath
      data: $.lockText
      createParents: true
    out:
      ok: wrote

  - call: lcod://tooling/script@1
    in:
      source: |
        async ({ state }) => ({
          lockPath: state.lockPath,
          components: Array.isArray(state.components) ? state.components : [],
          warnings: Array.isArray(state.warnings) && state.warnings.length > 0
            ? state.warnings
            : undefined
        })
      input:
        lockPath: $.lockPath
        components: $.lockDocument.components
        warnings: $.warnings
    out:
      lockPath: lockPath
      components: components
      warnings: warnings
